udptun
======

udptun is a UDP tunneling device implemented as a kernel module.
It can be created and configured via netlink.

* [X] Adding and removing tunnel interfaces via netlink
* [X] Encapsulation of IPv4 and IPv6 packets
* [X] Transmission of encapsulated UDP packets via IPv4 and IPv6
* [ ] Fixing packet loss / speed issues

## Using Vagrant

1. Start the Vagrant VM:

```
vagrant up
```

2. Set up the tunnel in the VM:

```
./setup-tunnel.sh
```

3. Start the local userspace tunnel endpoint:

```
cd udptun-go/src
go build . && sudo ./main run --ip 192.168.2.2/24
```

### Running iperf

We should have tunnel interfaces called `test` in the VM and locally with the IP addresses below:

- `192.168.2.1` - Vagrant VM
- `192.168.2.2` - host machine


Start the iperf3 server locally:

```
iperf3 -s
```

Connect to the VM and start the iperf3 client:

```
vagrant ssh
iperf3 -c 192.168.2.2
```



## Using OpenWRT

This repository is an OpenWRT feed.

### Content

* `openspot-kmod-udptun` the udptun kernel module
* `udptun-go` userspace tool to set up a tunnel, also includes `authorized_keys` for SSH
* `diffconfig` the minimal OpenWRT configuration generated by `scripts/diffconfig` from OpenWRT


### Feeds

Add a `feeds.conf` to your OpenWRT folder with the content below:

```
src-git packages https://git.openwrt.org/feed/packages.git;openwrt-19.07
src-link udptun /home/dev/udptun
```

Then run:

```
cd $openwrt
scripts/feeds update -a
scripts/feeds install udptun-go
```

### Building

```
cd $openwrt
make -j8
scp bin/targets/ramips/mt7621/openwrt-ramips-mt7621-ubnt-erx-squashfs-sysupgrade.bin root@erx.dev.digineo.de:/tmp/
```

### Flashing

```
picocom -b 57600 /dev/ttyUSB0
sysupgrade /tmp/*-sysupgrade.bin
```

## DropWatch

[DropWatch](https://github.com/nhorman/dropwatch) shows where in the kernel packet loss happens.
Install the required dependencies:

### Installation
```
sudo apt-get install autoconf automake pkg-config libtool libreadline-dev binutils-dev libnl-3-dev libnl-genl-3-dev
sudo apt-get source dropwatch
cd dropwatch
./autogen.sh
./configure
make
sudo make install
```

### Running

```
sudo dropwatch -l kas
```
